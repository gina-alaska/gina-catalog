- sortable = [['Sort: Relevance', ''],['Sort: Title', 'title_sort'], ['Sort: Type', 'record_type'], ['Sort: Status', 'status'], ['Sort: Agency', 'source_agency_acronym']]
- sortdir = [['Ascending', 'asc'], ['Descending', 'desc']]
%table.table.table-striped.table-condensed#catalog-items
  %thead
    %tr
      %td{colspan:10,style:'padding:0;'}
        = form_tag manager_catalogs_path, method: 'GET', class: 'form-inline well well-small', style: "margin: 0;" do
          = hidden_field_tag 'search[editable]', @search[:editable] || 'false', id: 'search_editable'
          = hidden_field_tag 'search[sds]', @search[:sds] || 'false', id: 'search_sds'
          = hidden_field_tag 'search[unpublished]', @search[:published_at] || 'false', id: 'search_unpublished'
          .btn-group
            .input-append
              = text_field_tag 'search[q]', @search[:q], placeholder: "Search"
              = submit_tag 'Search', class: 'btn btn-primary'
          .btn-group
            %button.btn{ type: "button", class: @search[:editable] == 'true' ? 'active' : '', data: { toggle: 'button', action: 'button-toggle', target: '#search_editable' }, title: 'Show editable records only' }
              %i.icon-edit              
            %button.btn{ type: "button", class: @search[:sds] == 'true' ? 'active' : '', data: { toggle: 'button', action: 'button-toggle', target: '#search_sds' }, title: 'Show SDS records only' }
              %i.icon-hdd              
            %button.btn{ type: "button", class: @search[:unpublished] == 'true' ? 'active' : '', data: { toggle: 'button', action: 'button-toggle', target: '#search_unpublished' }, title: 'Show unpublished records only' }
              %i.icon-folder-close-alt              
            = select_tag "sort", options_for_select(sortable, params[:sort]), class: 'span2'
            = select_tag "sort_direction", options_for_select(sortdir, @sortdir), class: 'span2'
    %tr
      %td{colspan:10,style:'padding:0;'}
        .navbar.navbar-static-top
          .navbar-inner
            .btn-group.pull-right
              = link_to new_manager_catalog_path, class: 'btn btn-success' do
                %i.icon-plus.icon-white
                New Record
            .btn-group
              %button#check-toggle.btn{data: { action: 'toggle-checkbox', target: '.item-checkbox' }, title: "Toggle CheckBoxes" }
                %i.icon-check
            .btn-group
              %button.btn{data: { action: 'expand-all', target: '.collapse' }, title: "Expand All"}
                %i.icon-plus-sign
              %button.btn{data: { action: 'collapse-all', target: '.collapse' }, title: "Collapse All"}
                %i.icon-minus-sign
  
            .btn-group
              = link_to '#', class: "btn dropdown-toggle", data: { toggle: "dropdown" } do
                Add to collection
                %b.caret
              %ul.dropdown-menu
                - current_setup.collections.each do |coll|
                  %li
                    %a{ id: coll.id, href: "#", onclick: "CollToggle(#{coll.id})"}
                      = coll.name
            .btn-group
              = link_to_first_page @catalogs, params: { search: @search }, class: 'btn' do
                %i.icon-double-angle-left
              = link_to_prev_page @catalogs, params: {search: @search}, class: 'btn' do
                %i.icon-angle-left
              %button.btn
                %span= display_result_info(@catalogs, @page, @limit, @total)
              = link_to_next_page @catalogs, params: {search: @search}, class: 'btn' do
                %i.icon-angle-right
              = link_to_last_page @catalogs, params: { search: @search }, class: 'btn' do
                %i.icon-double-angle-right
    %tr
      %th{style:'width:25px;'}
      %th Title
      %th Type
      %th Status
      %th Start year
      %th End year
      %th Source agency
      %th Editable?
      %th Published?
      %th
        %span{title: "Number of Downloads"}
          DLs
  %tbody
    - @catalogs.each do |item|
      %tr{data: { toggle: 'collapse', target: "#row_#{dom_id(item)}" }}
        %td{style:"text-align:center; padding:0;"}
          %label{for: "coll_check_#{item.id}", style: "display:block; min-height:50px;"}
            = check_box_tag "coll_check[#{item.id}]", item.id, nil, class: 'item-checkbox'
        
        %td
          = link_to item.title.truncate(150).humanize, [:manager, item]
          .collapse{id: "row_#{dom_id(item)}"}
            %small
              %dl.dl-horizontal
                - unless item.short_description.nil?
                  %dt Description:
                  %dd= item.short_description.try(:humanize)
                - if item.tags.size > 0
                  %dt Tags:
                  %dd= item.tags.list
                - if item.collections.size > 0
                  %dt Collections:
                  %dd= item.collections.list
                - if item.primary_contact
                  %dt Primary Contact:
                  %dd= item.primary_contact
        %td= item.type.humanize
        %td= item.status.try(:humanize)
        %td= item.start_date.try(:year)
        %td= item.end_date.try(:year)
        %td= item.source_agency
        %td
          -if item.owner_setup.nil?
            Udef
          -else
            - if item.owner_setup == current_setup 
              Yes
            - else
              %abbr{ title: "This record is shared from the #{item.owner_setup.try(:title)} portal"} No
        %td
          - if item.published_at.nil?
            No
          - else
            Yes
        %td=item.contact_infos.count

.center-paging
  .btn-group
    = link_to_first_page @catalogs, params: { search: @search }, class: 'btn' do
      %i.icon-double-angle-left
    = link_to_prev_page @catalogs, params: {search: @search}, class: 'btn' do
      %i.icon-angle-left
    %button.btn
      %span= display_result_info(@catalogs, @page, @limit, @total)
    = link_to_next_page @catalogs, params: {search: @search}, class: 'btn' do
      %i.icon-angle-right
    = link_to_last_page @catalogs, params: { search: @search }, class: 'btn' do
      %i.icon-double-angle-right

:javascript
  $(document).ready(function() {
    $('[data-action="toggle-checkbox"]').on('click', function() {
      $($(this).data('target')).attr("checked", function() {
        $(this).prop("checked", !$(this).attr("checked"));
      });
    });
    
    $('[data-action="button-toggle"]').on('click', function(evt) {
      if( $(this).attr('data-toggle') == 'button' ) {
        evt.stopPropagation();
        var target = $(this).data('target');
        $(this).toggleClass('active');
      
        if( $(this).hasClass('active') ) {
          $(target).val('true');
        } else {
          $(target).val('false');
        }
        $(target).parents('form').submit();
      }
    });
  })

  function CollToggle(coll_id) {  
    check_list = [];
    $('input:checkbox').attr("checked", function() {
      if ($(this).attr("checked")) {
        check_list.push($(this).val());
      }
    });
    
    $.ajax({
      url: "#{manager_collections_path}/" + coll_id + '/add',
      type: 'PUT',
      data: {
        "catalog_ids[]": check_list
      },
      complete: function(){
        location.reload();
      }
    });
  };
