.navbar.navbar-static-top
  .navbar-inner
    = link_to new_manager_catalog_path, class: 'btn btn-success' do
      %i.icon-plus.icon-white
      New Record
    = link_to '#', data: { action: 'expand-all', target: '.collapse' }, class: 'btn' do
      %i.icon-plus-sign
      Expand All
    = link_to '#', data: { action: 'collapse-all', target: '.collapse' }, class: 'btn' do
      %i.icon-minus-sign
      Collapse All
    %a.btn{ id: "collections", href: "#", class: "dropdown-toggle", data: {toggle: "dropdown"} }
      Add to collection
      %b.caret
    %ul.dropdown-menu
      -@setup.catalog_collections.each do |coll|
        %li
          %a{ id: coll.id, href: "#", class: "navbar-text", onclick: "CollToggle(#{coll.id})"}
            = coll.name

    = form_tag manager_catalogs_path, method: 'GET', class: 'navbar-form form-search pull-right' do        
      .input-append
        = text_field_tag 'search[q]', @search[:q], class: 'search-query span4', placeholder: "Search"
        = submit_tag 'Search', class: 'btn btn-primary'


= paginate @catalogs
%table.table.table-bordered.table-striped.table-condensed#catalog-items
  %thead
    %tr
      %th
        %button#check-toggle.btn.btn-mini{data: { action: 'toggle-checkbox', target: '.item-checkbox' } }
          %i.icon-search.icon-arrow-down
      %th Title
      %th Type
      %th Status
      %th Start year
      %th End year
      %th Source agency
  %tbody
    - @catalogs.each do |item|
      %tr{data: { toggle: 'collapse', target: "#row_#{dom_id(item)}" }}
        %td{style:"text-align:center; padding:0;"}
          %label{for: "coll_check_#{item.id}", style: "display:block; min-height:50px;"}
            = check_box_tag "coll_check[#{item.id}]", item.id, nil, class: 'item-checkbox'
        
        %td
          = link_to item.title.truncate(150).humanize, [:manager, item]
          .collapse{id: "row_#{dom_id(item)}"}
            %small
              %dl.dl-horizontal
                - unless item.short_description.nil?
                  %dt Description:
                  %dd= item.short_description.try(:humanize)
                - if item.tags.size > 0
                  %dt Tags:
                  %dd= item.tags.list
                - if item.catalog_collections.size > 0
                  %dt Collections:
                  %dd= item.catalog_collections.list
                - if item.primary_contact
                  %dt Primary Contact:
                  %dd= item.primary_contact
        %td= item.type.humanize
        %td= item.status.try(:humanize)
        %td= item.start_date.try(:year)
        %td= item.end_date.try(:year)
        %td= item.source_agency

= paginate @catalogs

:javascript
  $(document).ready(function() {
    $('[data-action="toggle-checkbox"]').on('click', function() {
      $($(this).data('target')).attr("checked", function() {
        $(this).prop("checked", !$(this).attr("checked"));
      });
    });
  })

  function CollToggle(coll_id) {  
    check_list = [];
    $('input:checkbox').attr("checked", function() {
      if ($(this).attr("checked")) {
        check_list.push($(this).val());
      }
    });
    
    $.ajax({
      url: "#{manager_catalog_collections_path}/" + coll_id + '/add',
      type: 'PUT',
      data: {
        "catalog_ids[]": check_list
      },
      complete: function(){
        location.reload();
      }
    });
  };
