/**
 * @class Manager.view.project.Edit
 * @extends Ext.panel.Panel
 * Edit Panel for Projects
 */
Ext.define('Manager.view.project.Edit', {
    extend: 'Ext.form.Panel', 
    alias: 'widget.project_edit',

    config: {
      recordId: null
    },
    
    titleTpl: new Ext.Template('Edit {id}::{title}'),

    constructor: function(config) {
      this.initConfig(config);
      this.callParent(arguments);
    },

    initComponent: function() {
      var source_agencies = Ext.create('Manager.store.Agencies', { autoLoad: true });
      var primary_contacts = Ext.create('Manager.store.Contacts', { autoLoad: true });
      
      var links = [];
      
      Ext.apply(this, {
        title: 'Loading...',
        autoScroll: true,
        closable: true,
        border: true,
        fieldDefaults: { anchor: '100%' },
        defaults: { layout: 'anchor', margin: '3 3 0 3' },
        dockedItems: [{
          xtype: 'toolbar',
          dock: 'bottom',
          ui: 'footer',
          defaults: { scale: 'large', minWidth: 100 },
          items: ['->', {
            text: 'Cancel'
          }, {
            text: 'Save',
            action: 'save'
          }]
        }],
        items: [{
          itemId: 'general', xtype: 'panel', title: 'General',
          bodyStyle: 'padding: 3px;',
          items: [
            { xtype: 'textfield', fieldLabel: 'Title', name: 'title' }, 
            { xtype: 'textarea', fieldLabel: 'Description', name: 'description' }, 
            { xtype: 'textfield', fieldLabel: 'Tags', name: 'tags' }, 
            {
              xtype: 'combobox', fieldLabel: 'Geo-Tags', queryMode: 'local', triggerAction: 'all',
              name: 'geokeyword_ids', multiSelect: true, editable: false, store: 'Geokeywords',
              displayField: 'name', valueField: 'id'
            },
            { xtype: 'textfield', fieldLabel: 'Start Date', name: 'start_date' }, 
            { xtype: 'textfield', fieldLabel: 'End Date', name: 'end_date' }, 
            {
              xtype: 'combobox', fieldLabel: 'Status', name: 'status', queryMode: 'local',
              store: 'ProjectStatus',  displayField: 'status', valueField: 'status'
            }, {
              xtype: 'combobox', fieldLabel: 'Owner', queryMode: 'remote', queryDelay: 100,
              triggerAction: 'all', minChars: 2, typeAhead: true, name: 'owner_id', store: 'Users',
              displayField: 'fullname_with_email', valueField: 'id'
            }
          ]
        }, {
          border: false,
          layout: { type: 'hbox', align: 'stretch' },
          items: [{
            xtype: 'panel', flex: 1, margins: '0 3 0 0', 
            bodyStyle: 'padding: 3px;', layout: 'anchor',
            itemId: 'agencies', title: 'Agencies', 
            items: [{
              xtype: 'combobox', fieldLabel: 'Source Agency', queryMode: 'remote', triggerAction: 'all',
              minChars: 3, typeAhead: true, name: 'source_agency_id', store: source_agencies,
              displayField: 'name_with_acronym', valueField: 'id' 
            }, {
              xtype: 'combobox', fieldLabel: 'Other Agencies', queryMode: 'local', triggerAction: 'all',
              editable: false, minChars: 3, name: 'agency_ids', store: 'Agencies', displayField: 'name_with_acronym',
              multiSelect: true, valueField: 'id'
            }]
          }, {
            xtype: 'panel', flex: 1, bodyStyle: 'padding: 3px;', layout: 'anchor',
            itemId: 'contacts', title: 'Contacts',
            items: [{
              xtype: 'combobox', fieldLabel: 'Primary Contact', queryMode: 'remote', triggerAction: 'all',
              minChars: 2, typeAhead: true, name: 'primary_contact_id', store: primary_contacts,
              displayField: 'fullname_with_email', valueField: 'id'
            }, {
              xtype: 'combobox', fieldLabel: 'Other Contacts', queryMode: 'local', triggerAction: 'all',
              name: 'person_ids', multiSelect: true, editable: false, store: 'Contacts',
              displayField: 'fullname_with_email', valueField: 'id'
            }]
          }]
        }, {
          itemId: 'links', xtype: 'panel', title: 'Links',
          bodyStyle: 'padding: 3px;',
          dockedItems: [{
            xtype:'toolbar',
            dock: 'top',
            items: [{ text: 'Add' }]
          }]
        },{
          itemId: 'locations', xtype: 'panel', title: 'Locations',
          bodyStyle: 'padding: 3px;'
        }]
      });       
      
      this.callParent(arguments);
      
      Ext.Ajax.request({
        url: '/catalog/' + this.getRecordId() + '.json',
        success: this.onRequestSuccess,
        scope: this
      });
    },

    buildLocation: function(loc){
      return {
        xtype: 'fieldcontainer',
        layout: { type: 'hbox', defaultMargins: { right: 3 } },
        fieldDefaults: { labelAlign: 'top' },
        items: [{
          xtype: 'hiddenfield', name: 'locations_attributes['+loc.id+'][id]', value: loc.id
        }, {
          xtype: 'textfield', fieldLabel: 'Name', flex: 1,
          name: 'locations_attributes['+ loc.id +'][name]', value: loc.name
        }, {
          xtype: 'textfield', fieldLabel: 'Geom', flex: 2,
          name: 'locations_attributes['+ loc.id + '][wkt]', value: loc.wkt
        }]
      };        
    },    
    
    buildLink: function(link){
      return {
        xtype: 'fieldcontainer',
        layout: { type: 'hbox', defaultMargins: { right: 3 } },
        fieldDefaults: { labelAlign: 'top' },
        items: [{
          xtype: 'hiddenfield', name: 'links_attributes['+link.id+'][id]', value: link.id
        }, {
          xtype: 'textfield', fieldLabel: 'Category', flex: 1,
          name: 'links_attributes['+ link.id +'][category]', value: link.category
        }, {
          xtype: 'textfield', fieldLabel: 'Text', flex: 1,
          name: 'links_attributes['+ link.id + '][display_text]', value: link.display_text
        }, {
          xtype: 'textfield', fieldLabel: 'URL', flex: 3,
          name: 'links_attributes['+ link.id + '][url]', value: link.url
        }]
      };        
    },
    
    onRequestSuccess: function(response){
      this.loadRecordData(Ext.JSON.decode(response.responseText));
    },
    
    loadRecordData: function(record){
      this.record = record;
      this.setTitle(this.titleTpl.apply(this.record));
      this.getForm().setValues(this.record);
      
      var links = this.down('#links');
      Ext.each(this.record.links, function(l) {
        links.add(this.buildLink(l));
      }, this);
      var locations = this.down('#locations');
      Ext.each(this.record.locations, function(l) {
        locations.add(this.buildLocation(l));
      }, this);
    }
});