/**
 * @class Manager.view.catalog.Form
 * @extends Ext.panel.Panel
 * Edit Panel for Projects
 */
Ext.define('Manager.shared_view.catalog.Form', {
    extend: 'Ext.form.Panel', 
    alias: 'widget.catalog_form',

    config: {
      recordId: null,
      recordType: 'project'
    },
    
    titleTpl: new Ext.Template('Edit {id}::{title}'),

    constructor: function(config) {
      this.initConfig(config);
      this.callParent(arguments);
    },

    initComponent: function() {
      this.addEvents('record_load');
      
      this.link_count = 0;
      this.location_count = 0;
   
      var links = [];
      Ext.apply(this, {
        title: 'Loading...',
        autoScroll: true,
        closable: true,
        border: true,
        fieldDefaults: { anchor: '100%', labelAlign: 'top' },
        defaults: { bodyStyle: 'padding: 3px;', layout: 'anchor', margin: '3 3 0 3' },
        dockedItems: [{
          xtype: 'toolbar', dock: 'bottom', ui: 'footer', cls: 'edit',
          defaults: { scale: 'large', minWidth: 100 },
          items: ['->', 
            { text: 'Cancel',action: 'cancel'}, 
            { text: 'Publish', action: 'publish'},
            { text: 'Save', action: 'save' }
          ]
        }],
        items: [{
          border: false,
          layout: { type: 'hbox', align: 'stretch' },
          bodyStyle: 'padding: 0',
          defaults: { layout: 'anchor', bodyStyle: 'padding: 3px;', flex: 1 },
          items: [{
            flex: 2,
            itemId: 'general', title: 'Description', margins: '0 3 0 0',
            xtype: (this.recordType == 'project' ? 'catalog_project_form_panel' : 'catalog_asset_form_panel')
          }, {
            itemId: 'properties', title: 'Properties', margins: '0 3 0 0',
            statusStore: (this.recordType == 'project' ? 'ProjectStatus' : 'AssetStatus'),
            xtype: 'catalog_properties_form_panel'
          }, {
            itemId: 'tags', title: 'Tags', margins: '0 3 0 0',
            xtype: 'catalog_tags_form_panel'
          }, {
            itemId: 'info', title: 'Info',
            xtype: 'catalog_info_panel'
          }]
        }, {
          border: false,
          layout: { type: 'hbox', align: 'stretch' },
          bodyStyle: 'padding: 0',
          defaults: {  bodyStyle: 'padding: 3px;', flex: 1 },
          items: [{
            itemId: 'agencies', xtype: 'catalog_agency_form_panel', title: 'Agencies', margins: '0 3 0 0'
          }, {
            itemId: 'contacts', xtype: 'catalog_contact_form_panel', title: 'Contacts' 
          }]
        }, {
          itemId: 'links', xtype: 'catalog_links_form_panel', title: 'Links'
        },{
          itemId: 'locations', xtype: 'catalog_location_form_panel', title: 'Locations'

        }]
      });     

      this.callParent(arguments);

      this.getForm().trackResetOnLoad = true;

      if(this.getRecordId()) {
        this.on('render', function() { 
          this.getEl().mask("Please Wait.."); 
          Ext.Ajax.request({
            url: '/catalog/' + this.getRecordId() + '.json',
            success: this.onRequestSuccess,
            scope: this
          });        
        }, this, {delay: 10, single:true} );
        this.on('record_load', function() {
          this.getEl().unmask();
        }, this, {delay: 1000});
      } else {
        this.setTitle(this.newTitle);
      }
      this.on('dirtychange', this.toggleButtons, this);
    },  
    
    onRequestSuccess: function(response){
      this.loadRecordData(Ext.JSON.decode(response.responseText));
    },
    
    loadRecordData: function(record){
      var links, locations;
      var now = new Date();
      
      this.record = record;
      this.setTitle(this.titleTpl.apply(this.record));
      this.getForm().setValues(this.record);
      
      links = this.down('#links');
      links.reset();
      Ext.each(this.record.links, links.addLink, links);
      
      locations = this.down('#locations');
      locations.reset();
      Ext.each(this.record.locations, locations.addLocation, locations);

      if(this.record.published_at && Date.parse(this.record.published_at) <= now) {
        this.down('button[action="publish"]').setText('Unpublish');
      } else {
        this.down('button[action="publish"]').setText('Publish');
      }
      this.down('button[action="save"]').disable();
      this.fireEvent('record_load', this, this.record);
    },

    toggleButtons: function(form, dirty) {
      if(dirty) {
        this.down('button[action="save"]').enable();
        this.down('button[action="publish"]').disable();
      } else {
        this.down('button[action="save"]').disable();
        this.down('button[action="publish"]').enable();
      }
    }
});